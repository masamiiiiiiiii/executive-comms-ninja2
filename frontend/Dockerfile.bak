
# Stage 1: Install dependencies and build
FROM node:18-alpine AS builder
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci

COPY . .

# Set environment variables for build
ARG NEXT_PUBLIC_API_URL="https://executive-comms-backend-577245028723.asia-northeast1.run.app/api"
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_SUPABASE_URL="https://jhdbumtiavjngwplqdzw.supabase.co"
ENV NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL
ARG NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoZGJ1bXRpYXZqbmd3cGxxZHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMDYzNjIsImV4cCI6MjA4Njg4MjM2Mn0.rWP-MRmG_HA3pz0dfpY2Kh0c0Vz0eqkTLasPSHjYjkM"
ENV NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY

RUN npm run build

# Stage 2: Run the production server
FROM node:18-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production

COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

EXPOSE 3000

ENV PORT 3000
CMD ["node", "server.js"]
